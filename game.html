<!-- game.html -->
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ø§Ù„Ù„Ø¹Ø¨ Ø£ÙˆÙ†Ù„Ø§ÙŠÙ†</title>

  <!-- ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ø¹Ø§Ù…Ø© Ù„Ù„ØµÙØ­Ø© -->
  <link rel="stylesheet" href="style(2).css" />

  <!-- ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ø§Ø®ØªÙŠØ§Ø±ÙŠØ© Ù„Ù„Ø´Ø§Øª ÙˆØ§Ù„Ø¥ÙŠÙ…ÙˆØ¬ÙŠ (Ø¥Ù† Ù„Ù… ØªÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ø© ÙŠÙ…ÙƒÙ† Ø­Ø°ÙÙ‡Ø§) -->
  <link rel="stylesheet" href="chat.css" />
  <link rel="stylesheet" href="emojis.css" />

  <!-- ØªÙ‡ÙŠØ¦Ø© ÙˆØ®Ø¯Ù…Ø§Øª -->
  <script src="firebase-init.js" defer></script>
  <script src="auth.js" defer></script>

  <!-- Ù…ÙŠØ²Ø§Øª Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø¥Ø¶Ø§ÙÙŠØ© -->
  <script src="chat.js" defer></script>
  <script src="emojis.js" defer></script>

  <!-- Ù…Ù†Ø·Ù‚ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ù„Ø§Ø¹Ø¨ ÙˆØ§Ù„Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ© -->
  <script src="game.js" defer></script>

  <style>
    /* Ù„Ù…Ø³Ø§Øª Ø³Ø±ÙŠØ¹Ø© Ù„ÙŠØ¸Ù‡Ø± ÙƒÙ„ Ø´ÙŠØ¡ Ù…Ø±ØªØ¨ Ø­ØªÙ‰ Ø¨Ø¯ÙˆÙ† chat.css / emojis.css */
    body { margin: 0; font-family: system-ui, sans-serif; background:#0f1320; color:#e8ecf1; }
    header, .controls { padding: 12px 16px; }
    header { display:flex; align-items:center; justify-content:space-between; }
    .btn { background:#3a6ff8; color:#fff; border:0; padding:10px 14px; border-radius:10px; cursor:pointer; }
    .btn.ghost { background:transparent; border:1px solid #3a6ff8; }
    #gameContainer { position:relative; width:100%; height:70vh; background:#0a0d18; border-top:1px solid #1b2238; border-bottom:1px solid #1b2238; }
    #gameFrame { width:100%; height:100%; border:0; background:#000; }

    /* Ø´Ø±ÙŠØ· Ø£Ø¯ÙˆØ§Øª Ø¹Ø§Ø¦Ù… */
    #floatingTools { position:fixed; bottom:16px; left:16px; display:flex; gap:8px; z-index:50; }
    #floatingTools .tool { background:#161b2e; border:1px solid #263259; color:#cfd8ff; border-radius:10px; padding:10px 12px; cursor:pointer; }

    /* Ù„ÙˆØ­Ø© Ø§Ù„Ø´Ø§Øª */
    #chatPanel { position:fixed; bottom:72px; left:16px; width:320px; max-width:92vw; background:#0f1426; border:1px solid #263259; border-radius:12px; overflow:hidden; display:none; z-index:60; }
    #chatHeader { display:flex; align-items:center; justify-content:space-between; padding:10px 12px; background:#131938; color:#cfd8ff; }
    #chatMessages { height:220px; overflow:auto; padding:10px 12px; display:flex; flex-direction:column; gap:6px; }
    .msg { background:#151b31; border:1px solid #28325a; color:#e8ecf1; padding:8px 10px; border-radius:8px; max-width:85%; }
    .msg.me { align-self:flex-end; background:#2a3a7a; }
    #chatInputBar { display:flex; gap:6px; padding:10px 12px; background:#0f1426; border-top:1px solid #263259; }
    #chatInput { flex:1; padding:8px 10px; border-radius:8px; border:1px solid #2a345d; background:#0b1023; color:#e8ecf1; }

    /* Ø´Ø±ÙŠØ· Ø§Ù„Ø¥ÙŠÙ…ÙˆØ¬ÙŠ */
    #emojiBar { position:fixed; bottom:72px; right:16px; width:320px; max-width:92vw; background:#0f1426; border:1px solid #263259; border-radius:12px; display:none; z-index:60; }
    #emojiHeader { display:flex; align-items:center; justify-content:space-between; padding:10px 12px; background:#131938; color:#cfd8ff; }
    #emojiGrid { display:grid; grid-template-columns:repeat(8, 1fr); gap:6px; padding:10px; max-height:220px; overflow:auto; }
    .emojiBtn { font-size:20px; line-height:36px; height:36px; text-align:center; cursor:pointer; border-radius:8px; background:#151b31; border:1px solid #28325a; }

    /* Ø­Ø§Ù„Ø© Ø§Ù„Ø¨Ø­Ø« */
    #matchStatus { margin-top: 10px; color:#a8b5ff; }
    #alternativeOptions { margin-top:10px; }
  </style>
</head>
<body>
  <header>
    <h2 style="margin:0;">Ù…Ø±Ø­Ø¨Ù‹Ø§ ÙŠØ§ <span id="playerName">...</span> ğŸ‘‹</h2>
    <div style="display:flex; gap:8px;">
      <button id="onlineBtn" class="btn">ğŸ® Ø§Ù„Ù„Ø¹Ø¨ Ø£ÙˆÙ†Ù„Ø§ÙŠÙ†</button>
      <button id="signOutBtn" class="btn ghost" title="ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬">ğŸšª Ø®Ø±ÙˆØ¬</button>
    </div>
  </header>

  <div class="controls">
    <div id="matchStatus"></div>

    <div id="alternativeOptions" style="display:none;">
      <p>ğŸ” Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù„Ø§Ø¹Ø¨ Ù…ØªØ§Ø­ Ø§Ù„Ø¢Ù†ØŒ Ù‡Ù„ ØªØ±ÙŠØ¯ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø¨Ø­Ø«ØŸ</p>
      <button class="btn" onclick="retryMatch()">Ù†Ø¹Ù…</button>
      <button class="btn ghost" onclick="playLocal()">Ù„Ø§ØŒ Ø§Ù„Ø¹Ø¨ Ø¶Ø¯ Ø§Ù„ÙƒÙ…Ø¨ÙŠÙˆØªØ±</button>
    </div>
  </div>

  <!-- Ø¹Ø±Ø¶ Ø§Ù„Ù„Ø¹Ø¨Ø© Ø§Ù„Ø£ØµÙ„ÙŠØ© Ø¯Ø§Ø®Ù„ Ø¥Ø·Ø§Ø± Ø¯ÙˆÙ† Ù„Ù…Ø³ Ù…Ù„ÙØ§ØªÙ‡Ø§ -->
  <section id="gameContainer">
    <iframe src="index.html" id="gameFrame" title="Ø§Ù„Ù„Ø¹Ø¨Ø© Ø§Ù„Ø£ØµÙ„ÙŠØ©"></iframe>
  </section>

  <!-- Ø£Ø¯ÙˆØ§Øª Ø¹Ø§Ø¦Ù…Ø©: ÙØªØ­/Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø´Ø§Øª ÙˆØ§Ù„Ø¥ÙŠÙ…ÙˆØ¬ÙŠ -->
  <div id="floatingTools">
    <button id="chatToggle" class="tool">ğŸ’¬ Ø§Ù„Ø´Ø§Øª</button>
    <button id="emojiToggle" class="tool">ğŸ˜„ Ø¥ÙŠÙ…ÙˆØ¬ÙŠ</button>
  </div>

  <!-- Ù„ÙˆØ­Ø© Ø§Ù„Ø´Ø§Øª -->
  <aside id="chatPanel" aria-hidden="true">
    <div id="chatHeader">
      <span>Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©</span>
      <button id="chatClose" class="tool" style="padding:6px 10px;">âœ–</button>
    </div>
    <div id="chatMessages"></div>
    <div id="chatInputBar">
      <input id="chatInput" type="text" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø©..." />
      <button id="chatSend" class="btn">Ø¥Ø±Ø³Ø§Ù„</button>
    </div>
  </aside>

  <!-- Ø´Ø±ÙŠØ· Ø§Ù„Ø¥ÙŠÙ…ÙˆØ¬ÙŠ -->
  <aside id="emojiBar" aria-hidden="true">
    <div id="emojiHeader">
      <span>Ø§Ù„Ø¥ÙŠÙ…ÙˆØ¬ÙŠ</span>
      <button id="emojiClose" class="tool" style="padding:6px 10px;">âœ–</button>
    </div>
    <div id="emojiGrid">
      <!-- Ø¨Ø¹Ø¶ Ø§Ù„Ø¥ÙŠÙ…ÙˆØ¬ÙŠØ§Øª Ø§Ù„Ø¬Ø§Ù‡Ø²Ø© ÙƒØ§ÙØªØ±Ø§Ø¶ÙŠØŒ ÙˆÙŠÙ…ÙƒÙ† Ù„Ù€ emojis.js Ø§Ø³ØªØ¨Ø¯Ø§Ù„Ù‡Ø§ Ø£Ùˆ Ø²ÙŠØ§Ø¯ØªÙ‡Ø§ -->
      <button class="emojiBtn" data-emoji="ğŸ˜€">ğŸ˜€</button>
      <button class="emojiBtn" data-emoji="ğŸ˜‚">ğŸ˜‚</button>
      <button class="emojiBtn" data-emoji="ğŸ¥³">ğŸ¥³</button>
      <button class="emojiBtn" data-emoji="ğŸ”¥">ğŸ”¥</button>
      <button class="emojiBtn" data-emoji="ğŸ’¯">ğŸ’¯</button>
      <button class="emojiBtn" data-emoji="ğŸ‘">ğŸ‘</button>
      <button class="emojiBtn" data-emoji="ğŸ˜">ğŸ˜</button>
      <button class="emojiBtn" data-emoji="ğŸ¤">ğŸ¤</button>
      <button class="emojiBtn" data-emoji="ğŸ‘€">ğŸ‘€</button>
    </div>
  </aside>

  <!-- Ø±Ø¨Ø· Ø¨Ø³ÙŠØ· Ø¨ÙŠÙ† Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© ÙˆØ§Ù„Ù„Ø¹Ø¨Ø© Ø¹Ø¨Ø± postMessage Ø¨Ø¯ÙˆÙ† Ù„Ù…Ø³ Ø§Ù„Ù„Ø¹Ø¨Ø© Ø§Ù„Ø£ØµÙ„ÙŠØ© -->
  <script>
    (function () {
      const gameFrame = document.getElementById('gameFrame');
      const chatPanel = document.getElementById('chatPanel');
      const emojiBar = document.getElementById('emojiBar');

      // ÙØªØ­/Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø´Ø§Øª
      document.getElementById('chatToggle').addEventListener('click', () => {
        chatPanel.style.display = chatPanel.style.display === 'none' || chatPanel.style.display === '' ? 'block' : 'none';
      });
      document.getElementById('chatClose').addEventListener('click', () => {
        chatPanel.style.display = 'none';
      });

      // ÙØªØ­/Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø¥ÙŠÙ…ÙˆØ¬ÙŠ
      document.getElementById('emojiToggle').addEventListener('click', () => {
        emojiBar.style.display = emojiBar.style.display === 'none' || emojiBar.style.display === '' ? 'block' : 'none';
      });
      document.getElementById('emojiClose').addEventListener('click', () => {
        emojiBar.style.display = 'none';
      });

      // Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© Ø´Ø§Øª Ù„Ù„Ù‘Ø§Ø¹Ø¨ Ø§Ù„Ø¢Ø®Ø± ÙˆÙ„Ù„Ù‘Ø¹Ø¨Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
      const chatInput = document.getElementById('chatInput');
      const chatSend = document.getElementById('chatSend');
      const chatMessages = document.getElementById('chatMessages');

      function appendMsg(text, mine = true) {
        const div = document.createElement('div');
        div.className = 'msg' + (mine ? ' me' : '');
        div.textContent = text;
        chatMessages.appendChild(div);
        chatMessages.scrollTop = chatMessages.scrollHeight;
      }

      function sendToGame(payload) {
        if (gameFrame && gameFrame.contentWindow) {
          gameFrame.contentWindow.postMessage(payload, '*');
        }
      }

      chatSend.addEventListener('click', () => {
        const text = chatInput.value.trim();
        if (!text) return;
        appendMsg(text, true);

        // Ø¥Ø±Ø³Ø§Ù„ Ù„Ù„Ø¹Ø¨Ø© ÙƒØ­Ø¯Ø« Ø¹Ø§Ù… (Ù„Ùˆ Ø­Ø¨ÙŠØª ØªØ¸Ù‡Ø± ÙÙ‚Ø§Ø¹Ø© Ø¯Ø§Ø®Ù„ Ø§Ù„Ù„ÙˆØ­Ø©)
        sendToGame({ type: 'chat', text });

        // ÙŠÙ…ÙƒÙ† Ù„Ù€ chat.js Ø£Ù† ÙŠØªÙƒÙÙ‘Ù„ Ø¨Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø£ÙˆÙ†Ù„Ø§ÙŠÙ† Ù„Ù„Ù…Ù†Ø§ÙØ³ Ø¹Ø¨Ø± Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        document.dispatchEvent(new CustomEvent('chat:send', { detail: { text } }));

        chatInput.value = '';
      });

      chatInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') chatSend.click();
      });

      // Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø£ÙŠ Ø¥ÙŠÙ…ÙˆØ¬ÙŠ ÙŠØ±Ø³Ù„ Ù„Ù„Ø¹Ø¨Ø© ÙˆÙŠØ¶Ø§Ù Ù„Ù„Ø´Ø§Øª
      document.getElementById('emojiGrid').addEventListener('click', (e) => {
        const btn = e.target.closest('.emojiBtn');
        if (!btn) return;
        const emoji = btn.dataset.emoji;
        appendMsg(emoji, true);
        sendToGame({ type: 'emoji', value: emoji });
        document.dispatchEvent(new CustomEvent('emoji:send', { detail: { emoji } }));
      });

      // Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø±Ø³Ø§Ø¦Ù„ Ø¹Ø§Ø¦Ø¯Ø© Ù…Ù† Ø§Ù„Ù„Ø¹Ø¨Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ Ù„Ø¹Ø±Ø¶Ù‡Ø§)
      window.addEventListener('message', (event) => {
        const data = event.data || {};
        if (data.type === 'chat') {
          appendMsg(data.text, false);
        }
        if (data.type === 'emoji') {
          appendMsg(data.value, false);
        }
      });

      // Ø²Ø± Ø§Ù„Ø®Ø±ÙˆØ¬ (Ù„Ùˆ auth.js ÙŠÙˆÙÙ‘Ø± signOut ÙŠÙ…ÙƒÙ†Ù†Ø§ Ø¥Ø·Ù„Ø§Ù‚ Ø­Ø¯Ø« Ø¹Ø§Ù…)
      document.getElementById('signOutBtn').addEventListener('click', () => {
        document.dispatchEvent(new CustomEvent('auth:signout'));
      });

      // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ø³Ù… Ø§Ù„Ù„Ø§Ø¹Ø¨ Ø¥Ù† Ù„Ù… ÙŠÙ‚Ù… auth.js Ø¨Ø°Ù„Ùƒ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§
      document.addEventListener('auth:username', (e) => {
        const name = (e.detail && e.detail.name) || 'Ù„Ø§Ø¹Ø¨';
        const span = document.getElementById('playerName');
        span.textContent = name;
      });

      // Ø¨Ø¯Ø¡ Ø§Ù„Ù„Ø¹Ø¨ Ø£ÙˆÙ†Ù„Ø§ÙŠÙ† Ø¹Ø¨Ø± game.js (Ù†ØªÙˆÙ‚Ø¹ Ø£Ù† game.js ÙŠØ³ØªÙ…Ø¹ Ù„Ù„Ø­Ø¯Ø«)
      document.getElementById('onlineBtn').addEventListener('click', () => {
        document.dispatchEvent(new CustomEvent('match:find'));
      });
    })();
  </script>
</body>
</html>
